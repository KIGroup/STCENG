<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Stc.DeepSee.OrderCube.Fact">
<Description><![CDATA[
Fact table for cube 'OrderCube'.<br/>
THIS IS A GENERATED CLASS, DO NOT EDIT.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.]]></Description>
<Final>1</Final>
<IncludeCode>%DeepSee</IncludeCode>
<Owner/>
<ProcedureBlock>1</ProcedureBlock>
<Super>%DeepSee.FactTable,%DeepSee.CubeFunctionSet</Super>
<TimeCreated>63753,77407.302675</TimeCreated>
<GeneratedBy>Stc.DeepSee.OrderCube.CLS</GeneratedBy>
<Inheritance>right</Inheritance>

<Parameter name="BITMAPCHUNKINMEMORY">
<Default>0</Default>
</Parameter>

<Parameter name="CUBENAME">
<Default>OrderCube</Default>
</Parameter>

<Parameter name="SOURCECLASS">
<Default>Stc.Data.Order</Default>
</Parameter>

<Index name="DxNameViaCourse">
<Description>
Index for fact 2.</Description>
<Type>bitmap</Type>
<Properties>DxNameViaCourse</Properties>
</Index>

<Index name="DxNameViaOrderStatus">
<Description>
Index for fact 3.</Description>
<Type>bitmap</Type>
<Properties>DxNameViaOrderStatus</Properties>
</Index>

<Index name="MxStudentsNumber">
<Description>
Index for measure M1.</Description>
<Type>bitslice</Type>
<Properties>MxStudentsNumber</Properties>
</Index>

<Property name="%sourceId">
<Description>
Reference to original data in source table.</Description>
<Type>Stc.Data.Order</Type>
</Property>

<Property name="%partition">
<Description>
This indicates which partition (set of 1M) this fact is in.</Description>
<Type>%Integer</Type>
<Calculated>1</Calculated>
<SqlComputeCode>Set {%partition}=({ID}\1024000)+1</SqlComputeCode>
<SqlComputed>1</SqlComputed>
</Property>

<Property name="DxNameViaCourse">
<Description><![CDATA[
Измерение : DxNameViaCourse<br/>
Источник: Course.Name]]></Description>
<Type>Stc.DeepSee.OrderCube.StarNameViaCourse</Type>
</Property>

<Property name="DxNameViaOrderStatus">
<Description><![CDATA[
Измерение : DxNameViaOrderStatus<br/>
Источник: OrderStatus.Name]]></Description>
<Type>Stc.DeepSee.OrderCube.StarNameViaOrderStatus</Type>
</Property>

<Property name="MxStudentsNumber">
<Description><![CDATA[
Показатель: MxStudentsNumber<br/>
Источник: StudentsNumber]]></Description>
<Type>%Integer</Type>
</Property>

<Method name="%Count">
<Description><![CDATA[
Return the total number of items within the Fact table.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.]]></Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Integer</ReturnType>
<Implementation><![CDATA[
 Set tCount = 0
 &sql(SELECT COUNT(*) INTO :tCount FROM Stc_DeepSee_OrderCube.Fact)
 Quit tCount
]]></Implementation>
</Method>

<Method name="%UpdateFacts">
<Description><![CDATA[
Update a range of Facts with data from the source table row with ids from <var>pStartId</var> to <var>pEndId</var>.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[pStartId:%String,pEndId:%String,pBatchMode:%Boolean=0,&pChunks:%Integer,pVerbose:%Boolean=0,pTaskGroup:%String="",*pUpdates:%Integer,pRefProp:%String="",pRefID:%String="",&pDimTables]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 Set tSC = $$$OK
 Set tRS = ""
 New %var,%source,%ROWID,%msg,%dsSourceId,%dsSourceObj
 Try {
 Set (SQLCODE,tStarId) = ""
 Set pUpdates = 0
 Set tLastCount = 0
 Set tID = ""
 Set tRows = 0
 If (pEndId="") {
  Set:+$G(%dsReadCommitted,1) oldzu=$ZU(115,2,1)
  Set pEndId=pStartId
 }
 If (pRefProp'="") {
  Set tRS = ##class(%ResultSet).%New()
  Set tSC = tRS.Prepare("SELECT %ID,%EXTERNAL(Course->Name) ""DxNameViaCourse"",%EXTERNAL(OrderStatus->Name) ""DxNameViaOrderStatus"",StudentsNumber ""MxStudentsNumber"" FROM Stc_Data.Order"_" WHERE "_pRefProp_"=?")
  If $$$ISERR(tSC) Quit
  Set tSC = tRS.Execute(pRefID)
  If $$$ISERR(tSC) Quit
 }
 ElseIf (pStartId=pEndId) {
  &sql(DECLARE sqeq1054731 CURSOR FOR
  SELECT %ID,%EXTERNAL(Course->Name) "DxNameViaCourse",%EXTERNAL(OrderStatus->Name) "DxNameViaOrderStatus",StudentsNumber "MxStudentsNumber" FROM Stc_Data.Order
  WHERE %ID = :pStartId
  )
  &sql(OPEN sqeq1054731)
  If (SQLCODE'=0) {
   Set tSC = $$$ERROR($$$GeneralError,"Error opening SQL cursor: ("_$G(SQLCODE)_") "_$G(%msg))
   Quit
  }
  &sql(FETCH sqeq1054731 INTO :tID,:%var("DxNameViaCourse"),:%var("DxNameViaOrderStatus"),:%var("MxStudentsNumber"))
 }
 Else {
  &sql(DECLARE sq1054731 CURSOR FOR
  SELECT %ID,%EXTERNAL(Course->Name) "DxNameViaCourse",%EXTERNAL(OrderStatus->Name) "DxNameViaOrderStatus",StudentsNumber "MxStudentsNumber" FROM Stc_Data.Order
  WHERE %ID BETWEEN :pStartId  AND :pEndId
  )
  &sql(OPEN sq1054731)
  If (SQLCODE'=0) {
   Set tSC = $$$ERROR($$$GeneralError,"Error opening SQL cursor: ("_$G(SQLCODE)_") "_$G(%msg))
   Quit
  }
  &sql(FETCH sq1054731 INTO :tID,:%var("DxNameViaCourse"),:%var("DxNameViaOrderStatus"),:%var("MxStudentsNumber"))
 }
 While ($S($IsObject(tRS):tRS.Next(.tSC),1:SQLCODE=0)) {
 Try {
 If ($IsObject(tRS)) {
  If $$$ISERR(tSC) Quit
  Set tID = $G(tRS.Data("%ID"))
  Set %var("DxNameViaCourse") = $G(tRS.Data("DxNameViaCourse"))
  Set %var("DxNameViaOrderStatus") = $G(tRS.Data("DxNameViaOrderStatus"))
  Set %var("MxStudentsNumber") = $G(tRS.Data("MxStudentsNumber"))
 }
 Set %dsSourceId = $G(tID)
 Set:pBatchMode tExStartTime = $ZH
 Set:pBatchMode x = $I(^CacheTemp.DeepSeeBuildStats($ZU(5),"ORDERCUBE","expr"),$ZH-tExStartTime)

 #; invoke method to process this fact
 Set tFactId = ""
 Set tSC = ##class(Stc.DeepSee.OrderCube.Fact).%ProcessFact(tID,pBatchMode,.%var,.tFactId,.tErrorMsg,.pDimTables)
 If (tFactId'="") {
 If $$$ISOK(tSC) {
  Set pUpdates = pUpdates+1
  Set pChunks(tFactId\64000+1) = ""
 }
 ElseIf (pVerbose) {
  Write "Error filing row: ",tID,!
  Write:tErrorMsg'="" tErrorMsg,!
  Do $System.Status.DisplayError(tSC)
  Set tSC = $$$OK
 }
 Kill pDimTables
 Set tRows = tRows + 1
 If (pVerbose&&'(tRows#1000)) Write $C(13,27)_"[0J"_"Building fact table: ",?25,$J($FN(tRows,",",0),10)," fact(s) updated."
 If (pVerbose&&'(tRows#1000)&&(+$G(%dserrcount))) Write " ",$J($FN(%dserrcount,",",0),10)," error(s)"
 If ((pTaskGroup'="")&&'(tRows#1000)) {
  Set tDelta = tRows - tLastCount
  Set inc=$I(^CacheTemp.DeepSeeUpdate($ZU(5),pTaskGroup,"facts"),tDelta)
  Set tLastCount = tRows
 }
 } ;factId
  }
  Catch (ex) {
    Set tSC = ex.AsStatus()
    If ($G(tID)'="") {
      S:($G($$$DeepSeeBuildErrorsGLVN("ORDERCUBE",tID))="") x = $I($$$DeepSeeBuildErrorsGLVN("ORDERCUBE"))
      Set $$$DeepSeeBuildErrorsGLVN("ORDERCUBE",tID) = tSC
    }
  }
  If '$IsObject(tRS) {
   If (pStartId=pEndId) {
    &sql(FETCH sqeq1054731 INTO :tID,:%var("DxNameViaCourse"),:%var("DxNameViaOrderStatus"),:%var("MxStudentsNumber"))
   }
   Else {
    &sql(FETCH sq1054731 INTO :tID,:%var("DxNameViaCourse"),:%var("DxNameViaOrderStatus"),:%var("MxStudentsNumber"))
   }
  }
 } ;while
  If '$IsObject(tRS) {
   If (pStartId=pEndId) {
    &sql(CLOSE sqeq1054731)
   }
   Else {
    &sql(CLOSE sq1054731)
   }
  }
 If (pVerbose) Write $C(13,27)_"[0J"_"Building fact table: "_$FN(+$G(tRows),",",0)_" fact(s) updated"
 If (pTaskGroup'="") {
  Set tDelta = tRows - tLastCount
  Set inc=$I(^CacheTemp.DeepSeeUpdate($ZU(5),pTaskGroup,"facts"),tDelta)
 }
 }
 Catch(ex) {
  Set tSC = ex.AsStatus()
  &sql(CLOSE sqeq1054731)
  &sql(CLOSE sq1054731)
 }
  Set:$D(oldzu) zu=$ZU(115,2,oldzu)
 If ($$$ISERR(tSC)) {
  Do ..%LogError(tSC)
  If (pVerbose) {
   Do $System.Status.DisplayError(tSC)
  }
  If ($G(tID)'="") {
   S:($G($$$DeepSeeBuildErrorsGLVN("ORDERCUBE",tID))="") x = $I($$$DeepSeeBuildErrorsGLVN("ORDERCUBE"))
   Set $$$DeepSeeBuildErrorsGLVN("ORDERCUBE",tID) = tSC
  }
 }
 Quit tSC
]]></Implementation>
</Method>

<Method name="%BuildAllFacts">
<Description><![CDATA[
Update all Facts with data from the source table.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pVerbose:%Boolean=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 Set tSC = $$$OK
 New %var,%source,%ROWID,%msg,%dsSourceId,%dsSourceObj
 Try {
 Set (SQLCODE,tStarId) = ""
 Set tLastCount = 0
 Set tID = ""
 Set tRows = 0
  &sql(DECLARE sq21054731 CURSOR FOR
  SELECT %ID,%EXTERNAL(Course->Name) "DxNameViaCourse",%EXTERNAL(OrderStatus->Name) "DxNameViaOrderStatus",StudentsNumber "MxStudentsNumber" FROM Stc_Data.Order
  )
  &sql(OPEN sq21054731)
  If (SQLCODE'=0) {
   Set tSC = $$$ERROR($$$GeneralError,"Error opening SQL cursor: ("_$G(SQLCODE)_") "_$G(%msg))
   Quit
  }
  &sql(FETCH sq21054731 INTO :tID,:%var("DxNameViaCourse"),:%var("DxNameViaOrderStatus"),:%var("MxStudentsNumber"))
  If ((SQLCODE=100)&&pVerbose) {
   Write "No source data found.",!
  }
  While (SQLCODE=0) {
  If ($D(%dsmaxfacts)&&(tRows>=+$G(%dsmaxfacts))) Quit
  Try {
 Set %dsSourceId = $G(tID)
 Set tExStartTime = $ZH
 Set x = $I(^CacheTemp.DeepSeeBuildStats($ZU(5),"ORDERCUBE","expr"),$ZH-tExStartTime)

 #; invoke method to process this fact
 Set tFactId = ""
 Set tSC = ##class(Stc.DeepSee.OrderCube.Fact).%ProcessFact(tID,1,.%var,.tFactId,.tErrorMsg)
 Set:$$$ISERR(tSC) err = $I(%dserrcount)
 If ($$$ISERR(tSC)&&pVerbose) {
  Write "Error filing row: ",tID,!
  Write:tErrorMsg'="" tErrorMsg,!
  Do $System.Status.DisplayError(tSC)
  Set tSC = $$$OK
 }
 If (tFactId'="") {
  Set tRows = tRows + 1
  Set:pVerbose %dsfactcount = tRows
  If (pVerbose&&'(tRows#1000)) Write $C(13,27)_"[0J"_"Building fact table: ",?25,$J($FN(tRows,",",0),10)," fact(s) updated."
  If (pVerbose&&'(tRows#1000)&&(+$G(%dserrcount))) Write " ",$J($FN(%dserrcount,",",0),10)," error(s)"
 } ;factId
  }
  Catch (ex) {
    Set tSC = ex.AsStatus()
    If ($G(tID)'="") {
      S:($G($$$DeepSeeBuildErrorsGLVN("ORDERCUBE",tID))="") x = $I($$$DeepSeeBuildErrorsGLVN("ORDERCUBE"))
      Set $$$DeepSeeBuildErrorsGLVN("ORDERCUBE",tID) = tSC
    }
  }
  &sql(FETCH sq21054731 INTO :tID,:%var("DxNameViaCourse"),:%var("DxNameViaOrderStatus"),:%var("MxStudentsNumber"))
 } ;while
  &sql(CLOSE sq21054731)
 If (pVerbose) Write $C(13,27)_"[0J"_"Building fact table: "_$FN(+$G(tRows),",",0)_" fact(s) updated"
 }
 Catch(ex) {
  Set tSC = ex.AsStatus()
  &sql(CLOSE sq21054731)
 }
 If ($$$ISERR(tSC)) {
  Do ..%LogError(tSC)
  If (pVerbose) {
   Do $System.Status.DisplayError(tSC)
  }
  If ($G(tID)'="") {
   S:($G($$$DeepSeeBuildErrorsGLVN("ORDERCUBE",tID))="") x = $I($$$DeepSeeBuildErrorsGLVN("ORDERCUBE"))
   Set $$$DeepSeeBuildErrorsGLVN("ORDERCUBE",tID) = tSC
  }
 }
 Quit tSC
]]></Implementation>
</Method>

<Method name="%BuildTempFile">
<Description><![CDATA[
Create a temp file of all source ids.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pTempKey:%String,*pImplemented:%Boolean,pVerbose:%Boolean=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 Set tSC = $$$OK
 New %var,%source,%ROWID,%msg,%dsSourceId,%dsSourceObj
 Set pImplemented = 1
 Try {
 Set (SQLCODE,tStarId) = ""
 Kill ^CacheTemp.DeepSeeSourceId(pTempKey)
 Set tID = ""
 Set tRows = 0
  &sql(DECLARE sq31054731 CURSOR FOR
  SELECT %ID FROM Stc_Data.Order
  )
  &sql(OPEN sq31054731)
  If (SQLCODE'=0) {
   Set tSC = $$$ERROR($$$GeneralError,"Error opening SQL cursor: ("_$G(SQLCODE)_") "_$G(%msg))
   Quit
  }
  &sql(FETCH sq31054731 INTO :tID)
  If ((SQLCODE=100)&&pVerbose) {
   Write "No source data found.",!
  }
  While (SQLCODE=0) {
  Set tRows = tRows+1
  Set tChunk = tRows\64000+1
  Set tOffset = tRows#64000+1
  Set:tID'="" ^CacheTemp.DeepSeeSourceId(pTempKey,tChunk,tOffset) = tID
  If (pVerbose&&'(tRows#10000)) Write $C(13,27)_"[0J"_"Building temp file: ",?25,$J($FN(tRows,",",0),10)," record(s) processed."
  If ($D(%dsmaxfacts)&&(tRows>=+$G(%dsmaxfacts))) Quit
  &sql(FETCH sq31054731 INTO :tID)
 } ;while
  &sql(CLOSE sq31054731)
 If (pVerbose) Write $C(13,27)_"[0J"_"Building temp file: "_$FN(+$G(tRows),",",0)_" record(s) processed"
 }
 Catch(ex) {
  Set tSC = ex.AsStatus()
  &sql(CLOSE sq31054731)
 }
 If ($$$ISERR(tSC)) {
  Do ..%LogError(tSC)
  If (pVerbose) {
   Do $System.Status.DisplayError(tSC)
  }
 }
 Quit tSC
]]></Implementation>
</Method>

<Method name="%ProcessFact">
<Description><![CDATA[
Perform the work of updating one fact in the cube.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[pID:%String,pBatchMode:%Boolean=0,&%var:%String,&pFactId:%Integer,*pErrorMsg:%String,&pDimTables,pDimensionsOnly:%Boolean=0]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 Set tSC = $$$OK
 New %ROWID,%msg,%value,%source,%expression
 Try {
  Set (SQLCODE,tStarId) = ""
  Set pErrorMsg = ""
  Set pFactId = $G(pFactId)
  Set %value = ""

  #; apply null replacements
  Set:(($G(%var("DxNameViaCourse"))="")||($G(%var("DxNameViaCourse"))=$C(0))) %var("DxNameViaCourse") = "<null>"
  Set:(($G(%var("DxNameViaOrderStatus"))="")||($G(%var("DxNameViaOrderStatus"))=$C(0))) %var("DxNameViaOrderStatus") = "<null>"

  If (pDimensionsOnly) {
   Set tFactId=""
   Set tIsInsert = 1
  }
  ElseIf (pBatchMode) {
   Set zuSetting = $zu(115,1,0)
   Set tIsInsert = 1
  }
  ElseIf (pID'="") {
   Set tFactId = $O($$$DeepSeeIndexGLVN("ORDERCUBE","%sourceId",pID,""))
   Set tIsInsert = ''(tFactId="")
  }
  ElseIf (pFactId'="") {
   If ($D($$$DeepSeeIndexGLVN("ORDERCUBE","%sourceIdReverse",pFactId))) {
    Set tFactId = pFactId
    Set tIsInsert = 0
   }
   Else {
    Set tFactId = ""
    Set tIsInsert = 1
   }
  }
  Else {
   Set tFactId = ""
   Set tIsInsert = 1
  }

 #; STAR Table: Stc.DeepSee.OrderCube.StarNameViaCourse
 If ($G(%var("DxNameViaCourse"))'="") {
  Set tStarId = $O(^DeepSee.DimensionI("STC.DEEPSEE.ORDERCUBE.STARNAMEVIACOURSE","Primary",$zu(28,%var("DxNameViaCourse"),7,113),""))
  If (tStarId '= "") {
   Set %var("DxNameViaCourse") = tStarId
  }
  Else {
  Set tLockKey = $zu(28,%var("DxNameViaCourse"),7,113)
  Lock +$$$DeepSeeIndexGLVN("Stc.DeepSee.OrderCube.StarNameViaCourse",tLockKey):15
  If '$Test {
   Set tSC = $$$ERROR($$$GeneralError,"Unable to acquire lock for dimension table: 'Stc_DeepSee_OrderCube.StarNameViaCourse'")
   Quit
  }
  Set tStarId = $O(^DeepSee.DimensionI("STC.DEEPSEE.ORDERCUBE.STARNAMEVIACOURSE","Primary",$zu(28,%var("DxNameViaCourse"),7,113),""))
   If (tStarId '= "") {
    Set %var("DxNameViaCourse") = tStarId
   }
   Else {
    &sql(INSERT INTO Stc_DeepSee_OrderCube.StarNameViaCourse (DxNameViaCourse) VALUES (:%var("DxNameViaCourse")))
    If (SQLCODE'=0) {
     Lock -$$$DeepSeeIndexGLVN("Stc.DeepSee.OrderCube.StarNameViaCourse",tLockKey)
     Set tSC = $$$ERROR($$$GeneralError,"Insert into dimension table failed: 'Stc_DeepSee_OrderCube.StarNameViaCourse' SQLCODE="_SQLCODE)
     Do ..%LogError(tSC)
     Quit
    }
    Set %var("DxNameViaCourse") = %ROWID
   }
   Lock -$$$DeepSeeIndexGLVN("Stc.DeepSee.OrderCube.StarNameViaCourse",tLockKey)
  }
 }

 #; STAR Table: Stc.DeepSee.OrderCube.StarNameViaOrderStatus
 If ($G(%var("DxNameViaOrderStatus"))'="") {
  Set tStarId = $O(^DeepSee.DimensionI("STC.DEEPSEE.ORDERCUBE.STARNAMEVIAORDERSTATUS","Primary",$zu(28,%var("DxNameViaOrderStatus"),7,113),""))
  If (tStarId '= "") {
   Set %var("DxNameViaOrderStatus") = tStarId
  }
  Else {
  Set tLockKey = $zu(28,%var("DxNameViaOrderStatus"),7,113)
  Lock +$$$DeepSeeIndexGLVN("Stc.DeepSee.OrderCube.StarNameViaOrderStatus",tLockKey):15
  If '$Test {
   Set tSC = $$$ERROR($$$GeneralError,"Unable to acquire lock for dimension table: 'Stc_DeepSee_OrderCube.StarNameViaOrderStatus'")
   Quit
  }
  Set tStarId = $O(^DeepSee.DimensionI("STC.DEEPSEE.ORDERCUBE.STARNAMEVIAORDERSTATUS","Primary",$zu(28,%var("DxNameViaOrderStatus"),7,113),""))
   If (tStarId '= "") {
    Set %var("DxNameViaOrderStatus") = tStarId
   }
   Else {
    &sql(INSERT INTO Stc_DeepSee_OrderCube.StarNameViaOrderStatus (DxNameViaOrderStatus) VALUES (:%var("DxNameViaOrderStatus")))
    If (SQLCODE'=0) {
     Lock -$$$DeepSeeIndexGLVN("Stc.DeepSee.OrderCube.StarNameViaOrderStatus",tLockKey)
     Set tSC = $$$ERROR($$$GeneralError,"Insert into dimension table failed: 'Stc_DeepSee_OrderCube.StarNameViaOrderStatus' SQLCODE="_SQLCODE)
     Do ..%LogError(tSC)
     Quit
    }
    Set %var("DxNameViaOrderStatus") = %ROWID
   }
   Lock -$$$DeepSeeIndexGLVN("Stc.DeepSee.OrderCube.StarNameViaOrderStatus",tLockKey)
  }
 }
 If ('pBatchMode) {
    Set tVal = %var("DxNameViaCourse")
    If ((tVal'="")&&('$D($$$DeepSeeIndexGLVN("ORDERCUBE",2,tVal)))) {
     Set ts = $I($$$DeepSeeResultsGLVN("ORDERCUBE","fact",2))
    }
    Set tVal = %var("DxNameViaOrderStatus")
    If ((tVal'="")&&('$D($$$DeepSeeIndexGLVN("ORDERCUBE",3,tVal)))) {
     Set ts = $I($$$DeepSeeResultsGLVN("ORDERCUBE","fact",3))
    }
 }
 #; INSERT or UPDATE data into fact table
 If (pDimensionsOnly) {
 }
 ElseIf (pBatchMode) {
  &sql(INSERT %NOLOCK %NOINDEX INTO Stc_DeepSee_OrderCube.Fact (%sourceId,DxNameViaCourse,DxNameViaOrderStatus,MxStudentsNumber)
       VALUES (:pID,:%var("DxNameViaCourse"),:%var("DxNameViaOrderStatus"),:%var("MxStudentsNumber")))
  Set pFactId = %ROWID
  If (pFactId'="") {
   Set:pID'="" $$$DeepSeeIndexGLVN("ORDERCUBE","%sourceId",pID,pFactId) = ""
   Set $$$DeepSeeIndexGLVN("ORDERCUBE","%sourceIdReverse",pFactId) = pID
  }
 }
 Else {
 If ($G(tFactId)'="") {
  &sql(UPDATE Stc_DeepSee_OrderCube.Fact (%sourceId,DxNameViaCourse,DxNameViaOrderStatus,MxStudentsNumber)
       VALUES (:pID,:%var("DxNameViaCourse"),:%var("DxNameViaOrderStatus"),:%var("MxStudentsNumber")) WHERE %ID = :tFactId)
  Set pFactId = tFactId
 }
 Else {
  &sql(INSERT INTO Stc_DeepSee_OrderCube.Fact (%sourceId,DxNameViaCourse,DxNameViaOrderStatus,MxStudentsNumber)
       VALUES (:pID,:%var("DxNameViaCourse"),:%var("DxNameViaOrderStatus"),:%var("MxStudentsNumber")))
  Set pFactId = %ROWID
  If (pFactId'="") {
   Set:pID'="" $$$DeepSeeIndexGLVN("ORDERCUBE","%sourceId",pID,pFactId) = ""
   Set $$$DeepSeeIndexGLVN("ORDERCUBE","%sourceIdReverse",pFactId) = pID
  }
 }
 }
 If (SQLCODE'=0) {
  Set pErrorMsg = $G(%msg)
  Set tSC = $$$ERROR($$$GeneralError,"Error inserting/updating fact: (Source ID:'"_pID_"') "_pErrorMsg)
  Do ..%LogError(tSC)
  Set x = $I($$$DeepSeeBuildErrorsGLVN("ORDERCUBE"))
  Set $$$DeepSeeBuildErrorsGLVN("ORDERCUBE",pID) = tSC
 }
 }
 Catch(ex) {
  Set tSC = ex.AsStatus()
  Set pErrorMsg = $ZE
  Do ..%LogError(tSC)
  Set x = $I($$$DeepSeeBuildErrorsGLVN("ORDERCUBE"))
  Set $$$DeepSeeBuildErrorsGLVN("ORDERCUBE",pID) = tSC
 }
 Set:$D(zuSetting) zuSetting = $zu(115,1,zuSetting)
 Quit tSC
]]></Implementation>
</Method>

<Method name="%OnStartBatch">
<Description><![CDATA[
Notification that a batch of facts are about to be processed.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pCubeName:%String,pVerbose:%Boolean=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[ Quit $$$OK
]]></Implementation>
</Method>

<Method name="%OnEndBatch">
<Description><![CDATA[
Notification that a batch of facts have just been processed.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pCubeName:%String,pVerbose:%Boolean=0</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[ Quit $$$OK
]]></Implementation>
</Method>

<Method name="%InjectFact">
<Description><![CDATA[
Perform the work of injecting one fact into the cube without associated source data.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[&pFactId:%Integer,&pValues:%String,*pChunks:%Integer,pDimensionsOnly:%Boolean=0]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 New %var,%source,%value
 Set tSC = $$$OK
 Try {
  Set %value=""
  Set %var("DxNameViaCourse") = $G(pValues("Course.Name~~EXTERNAL"),$G(pValues("Course.Name")))
  Set %var("DxNameViaOrderStatus") = $G(pValues("OrderStatus.Name~~EXTERNAL"),$G(pValues("OrderStatus.Name")))
  Set %var("MxStudentsNumber") = $G(pValues("StudentsNumber"))

  #; invoke method to process this fact
  Set pFactId = $G(pFactId)
  Set tSC = ##class(Stc.DeepSee.OrderCube.Fact).%ProcessFact("",0,.%var,.pFactId,.pErrorMsg,,pDimensionsOnly)
  If $$$ISOK(tSC) {
   Set:(pFactId'="")&&('pDimensionsOnly) pChunks(pFactId\64000+1) = ""
  }
 }
 Catch(ex) {
  Set tSC = ex.AsStatus()
  Do ..%LogError(tSC)
  Set x = $I($$$DeepSeeBuildErrorsGLVN("ORDERCUBE"))
  Set $$$DeepSeeBuildErrorsGLVN("ORDERCUBE",pID) = tSC
 }
 Quit tSC
]]></Implementation>
</Method>

<Method name="%DeleteFact">
<Description><![CDATA[
Perform the work of deleting one fact in the cube.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec>pID:%String,*pFactId:%Integer,*pErrorMsg:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 Set tSC = $$$OK
 New %ROWID,%msg
 Try {
  Set (SQLCODE,tStarId) = ""
  Set pErrorMsg = ""
  Set pFactId = ""
  Set pFactId = $O($$$DeepSeeIndexGLVN("ORDERCUBE","%sourceId",pID,""))
  If (pFactId'="") {
   &sql(DELETE FROM Stc_DeepSee_OrderCube.Fact WHERE %ID = :pFactId)
   Kill $$$DeepSeeIndexGLVN("ORDERCUBE","%sourceId",pID,pFactId)
   Kill $$$DeepSeeIndexGLVN("ORDERCUBE","%sourceIdReverse",pFactId)
  }
 }
 Catch(ex) {
  Set tSC = ex.AsStatus()
  Set pErrorMsg = $ZE
  Do ..%LogError(tSC)
 }
 Quit tSC
]]></Implementation>
</Method>

<Method name="%OnKillFacts">
<Description><![CDATA[
Notification that this cube is being killed.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 Set tSC = $$$OK
 Try {
 }
 Catch(ex) {
  Set tSC = ex.AsStatus()
  Do ..%LogError(tSC)
 }
 Quit tSC
]]></Implementation>
</Method>

<Method name="%PrecomputeAggregates">
<Description><![CDATA[
Pre-compute certain aggregates.<br/>
Generated by %DeepSee.Generator:%CreateFactTable.<br/>
DO NOT CALL THIS METHOD DIRECTLY]]></Description>
<ClassMethod>1</ClassMethod>
<FormalSpec><![CDATA[pStartChunk:%Integer,pEndChunk:%Integer,pAggGLVN:%String,pVerbose:%Boolean=0,pTaskGroup:%String="",&pCount:%Integer=0]]></FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
 Set tSC = $$$OK
 New %ROWID,%msg,%var
 Kill @pAggGLVN
 Try {
  Set (SQLCODE) = ""
  Set tLastCount = 0
 If (pTaskGroup'="") {
  Set tDelta = pCount - tLastCount
  Set inc=$I(^CacheTemp.DeepSeeUpdate($ZU(5),pTaskGroup,"facts"),tDelta)
 }
 }
 Catch(ex) {
  Set tSC = ex.AsStatus()
  Set pErrorMsg = $ZE
  Do ..%LogError(tSC)
 }
 Quit tSC
]]></Implementation>
</Method>

<Storage name="Default">
<Type>%Library.CacheStorage</Type>
<DataLocation>^DeepSee.Fact("STC.DEEPSEE.ORDERCUBE.FACT")</DataLocation>
<DefaultData>FactDefaultData</DefaultData>
<IdLocation>^DeepSee.Fact("STC.DEEPSEE.ORDERCUBE.FACT")</IdLocation>
<IndexLocation>^Stc.DeepSee.OrderCube.FactI</IndexLocation>
<StreamLocation>^DeepSee.FactS("STC.DEEPSEE.ORDERCUBE.FACT")</StreamLocation>
<ExtentSize>10000000</ExtentSize>
<Data name="FactDefaultData">
<Structure>listnode</Structure>
<Subscript/>
<Value name="1">
<Value>%sourceId</Value>
</Value>
<Value name="2">
<Value>DxNameViaCourse</Value>
</Value>
<Value name="3">
<Value>DxNameViaOrderStatus</Value>
</Value>
<Value name="4">
<Value>MxStudentsNumber</Value>
</Value>
</Data>
<Index name="$Fact">
<Location>^DeepSee.Index("ORDERCUBE","$Fact")</Location>
</Index>
<Index name="DxNameViaCourse">
<Location>^DeepSee.Index("ORDERCUBE",2)</Location>
</Index>
<Index name="DxNameViaOrderStatus">
<Location>^DeepSee.Index("ORDERCUBE",3)</Location>
</Index>
<Index name="MxStudentsNumber">
<Location>^DeepSee.Index("ORDERCUBE","M1")</Location>
</Index>
</Storage>
</Class>
</Export>
